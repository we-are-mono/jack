name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Test and Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for accurate coverage

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Install dependencies
      run: |
        go mod download
        go mod verify

    - name: Run unit tests with coverage
      run: |
        go test -v -race -coverprofile=coverage-unit.out -covermode=atomic ./...

    - name: Run integration tests with coverage
      run: |
        # Build cached base image (OS + Go dependencies)
        docker build -t jack-integration-base -f Dockerfile.test .

        # Build binaries locally
        mkdir -p bin
        go build -o jack
        cd plugins/core/nftables && go build -o ../../../bin/jack-plugin-nftables .
        cd ../wireguard && go build -o ../../../bin/jack-plugin-wireguard .
        cd ../dnsmasq && go build -o ../../../bin/jack-plugin-dnsmasq .
        cd ../monitoring && go build -o ../../../bin/jack-plugin-monitoring .
        cd ../leds && go build -o ../../../bin/jack-plugin-leds .
        cd ../sqlite3 && CGO_ENABLED=1 go build -o ../../../bin/jack-plugin-sqlite3 .
        cd ../../..

        # Run integration tests with coverage (mount code and binaries)
        mkdir -p coverage-data
        docker run --rm --privileged --cap-add=ALL \
          -v $(pwd):/opt/jack \
          -v $(pwd)/bin:/usr/lib/jack/plugins \
          -v $(pwd)/coverage-data:/coverage-data \
          -w /opt/jack \
          jack-integration-base \
          sh -c 'go mod download && go test -v -p=1 -tags=integration -covermode=atomic -coverprofile=/coverage-data/integration.out -coverpkg=./... ./test/integration/...'

        # Copy integration coverage file
        cp coverage-data/integration.out coverage-integration.out

    - name: Merge coverage profiles
      run: |
        go run ./test/tools/mergecoverage.go coverage-unit.out coverage-integration.out > coverage-combined.out

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage-combined.out
        flags: combined
        name: combined-coverage
        fail_ci_if_error: true
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Check coverage threshold
      run: |
        COVERAGE=$(go tool cover -func=coverage-combined.out | grep total | awk '{print $3}' | sed 's/%//')
        COVERAGE_INT=$(echo "$COVERAGE" | awk -F. '{print $1}')
        MIN_COVERAGE=50

        echo "Coverage: ${COVERAGE}% (minimum: ${MIN_COVERAGE}%)"

        if [ $COVERAGE_INT -lt $MIN_COVERAGE ]; then
          echo "❌ FAILED: Coverage ${COVERAGE}% is below minimum ${MIN_COVERAGE}%"
          exit 1
        else
          echo "✅ PASSED: Coverage ${COVERAGE}% meets minimum ${MIN_COVERAGE}%"
        fi
